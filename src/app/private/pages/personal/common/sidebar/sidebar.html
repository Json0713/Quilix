<aside class="sidebar" [class.collapsed]="isCollapsed()" [class.mobile-open]="isMobileOpen()">
    <div class="sidebar-header">
        @if (!isCollapsed()) {
        <a class="logo-container" [routerLink]="['./']" (click)="toggleSidebar()" title="Quilix">
            <i class="bi bi-feather logo-icon"></i>
            <span class="logo-text">Quilix</span>
        </a>
        }
        <button class="toggle-btn" (click)="toggleSidebar()" [class.centered]="isCollapsed()"
            [title]="isCollapsed() ? 'Expand' : 'Close'">
            <i class="bi" [class.bi-layout-sidebar-inset]="!isCollapsed()"
                [class.bi-layout-sidebar]="isCollapsed()"></i>
        </button>
    </div>

    <!-- Main nav (pinned, never scrolls) -->
    <div class="main-nav-pinned">
        <ul class="nav-list">
            @for (item of navItems; track item.label) {
            <li class="nav-item">
                <a [routerLink]="item.route" routerLinkActive="active"
                    [routerLinkActiveOptions]="{ exact: item.route === './' }" class="nav-link" [title]="item.label"
                    (click)="onNavClick(item)">
                    <i [class]="item.icon" class="nav-icon"></i>
                    @if (!isCollapsed()) {
                    <span class="nav-label">{{ item.label }}</span>
                    }
                </a>
            </li>
            }
        </ul>
    </div>

    <!-- Scrollable area (only spaces content scrolls) -->
    <nav class="sidebar-nav">
        @if (activeWorkspace()) {
        <div class="nav-section spaces-section">
            @if (!isCollapsed()) {
            <div class="section-title">MySpace</div>
            } @else {
            <div class="section-divider"></div>
            }

            <!-- + New nav button -->
            <ul class="nav-list">
                <li class="nav-item">
                    <button class="nav-link new-space-nav" (click)="startCreating()" title="New space">
                        <i class="bi bi-plus-lg nav-icon"></i>
                        @if (!isCollapsed()) {
                        <span class="nav-label">New</span>
                        }
                    </button>
                </li>
            </ul>

            <!-- Inline create input -->
            @if (isCreating() && !isCollapsed()) {
            <div class="space-create-inline" [class.has-error]="inputError()">
                <i class="bi bi-folder-plus create-icon"></i>
                <div class="input-wrapper">
                    <input #spaceInput type="text" class="space-name-input" placeholder="New space"
                        [value]="newSpaceName()" (input)="onSpaceInput($any($event.target).value)"
                        (keydown)="onSpaceInputKeydown($event)" (blur)="confirmCreate()" maxlength="50" />
                    @if (inputError()) {
                    <div class="input-error-tooltip">
                        <i class="bi bi-exclamation-circle"></i>
                        <span>{{ inputError() }}</span>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Space list -->
            <ul class="nav-list space-list" cdkDropList [cdkDropListData]="spaces()"
                (cdkDropListDropped)="onSpaceDrop($event)">
                @for (space of spaces(); track space.id) {
                <li class="nav-item space-item" [class.menu-open]="openMenuId() === space.id" cdkDrag>
                    <div *cdkDragPreview class="sidebar-drag-preview">
                        <i class="bi bi-folder nav-icon"></i>
                        <span class="nav-label">{{ space.name }}</span>
                    </div>

                    @if (renamingSpaceId() === space.id) {
                    <!-- Inline rename input -->
                    <div class="space-rename-inline" [class.has-error]="renameError()">
                        <i class="bi bi-folder nav-icon rename-icon"></i>
                        <input #renameInput type="text" class="space-rename-input" [value]="renameValue()"
                            (input)="onRenameInput($any($event.target).value)" (keydown)="onRenameKeydown($event)"
                            maxlength="50" />
                    </div>
                    } @else {
                    <a class="nav-link space-link" [title]="space.name" [routerLink]="'./spaces/' + space.id"
                        routerLinkActive="active" #rla="routerLinkActive" (click)="onSpaceClick(space)">
                        <i class="bi bi-folder nav-icon"></i>
                        @if (!isCollapsed()) {
                        <span class="nav-label">{{ space.name }}</span>
                        }
                    </a>

                    @if (!isCollapsed()) {
                    <button class="space-menu-trigger" (click)="toggleMenu(space.id, $event)" title="Options">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>

                    @if (openMenuId() === space.id) {
                    <div class="space-menu-dropdown">
                        <button class="dropdown-item rename-item" (click)="startRename(space, $event)">
                            <i class="bi bi-pencil"></i>
                            <span>Rename</span>
                        </button>
                        <button class="dropdown-item trash-item" (click)="trashSpace(space.id, $event)">
                            <i class="bi bi-trash3"></i>
                            <span>Move to Trash</span>
                        </button>
                    </div>
                    }
                    }
                    }
                </li>
                }
            </ul>
        </div>
        }
    </nav>

    <!-- System section (pinned pre-footer) -->
    <div class="system-pinned">
        @if (!isCollapsed()) {
        <div class="section-title">System</div>
        } @else {
        <div class="section-divider"></div>
        }
        <ul class="nav-list">
            <li class="nav-item">
                <a routerLink="./trash" routerLinkActive="active" class="nav-link" title="Trash"
                    (click)="onNavClick({ label: 'Trash', icon: 'bi bi-trash3', route: './trash' })">
                    <i class="bi bi-trash3 nav-icon"></i>
                    @if (!isCollapsed()) {
                    <span class="nav-label">Trash</span>
                    }
                </a>
            </li>
        </ul>
    </div>

    <div class="sidebar-footer">
        <div class="profile-section">
            <i class="bi bi-person-circle profile-icon"></i>
            @if (!isCollapsed()) {
            <div class="profile-info">
                <span class="profile-name">Jason O. Bayaga</span>
                <span class="profile-role">IQA Officer</span>
            </div>
            }
        </div>

        <app-personal-settings-kit />
    </div>
</aside>
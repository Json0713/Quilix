<div class="trash-container">
    <div class="trash-header">
        <div class="header-text">
            <h2>Trash</h2>
            <p>Items in trash are automatically deleted forever after 30 days.</p>
        </div>

        @if (!isLoading() && hasAnyTrashed()) {
        <button class="select-toggle-btn" (click)="toggleSelectionMode()" [class.active]="selectionMode()">
            @if (selectionMode()) {
            <i class="bi bi-x-lg"></i>
            <span>Cancel</span>
            } @else {
            <i class="bi bi-check2-square"></i>
            <span>Select</span>
            }
        </button>
        }
    </div>

    <!-- Re-auth banner (permission lost after reload on mobile) -->
    @if (needsReauth() && isFileSystemMode()) {
    <div class="reauth-banner">
        <div class="reauth-info">
            <i class="bi bi-shield-lock"></i>
            <div class="reauth-text">
                <strong>Storage access needed</strong>
                <span>Reconnect to fully delete workspace folders from your device.</span>
            </div>
        </div>
        <button class="reauth-btn" (click)="reconnectStorage()" [disabled]="isReauthing()">
            @if (isReauthing()) {
            <i class="bi bi-arrow-repeat spin"></i>
            <span>Connecting...</span>
            } @else {
            <i class="bi bi-plug"></i>
            <span>Reconnect Storage</span>
            }
        </button>
    </div>
    }

    <!-- Selection toolbar -->
    @if (selectionMode()) {
    <div class="selection-toolbar">
        <div class="toolbar-left">
            <button class="toolbar-btn checkbox-btn" (click)="toggleSelectAll()" [class.checked]="isAllSelected()">
                <i class="bi" [class.bi-check-square-fill]="isAllSelected()" [class.bi-square]="!isAllSelected()"></i>
            </button>
            <span class="selection-count">
                {{ selectedCount() }} selected
            </span>
        </div>

        <div class="toolbar-actions">
            @if (confirmingBulkDelete()) {
            <div class="bulk-confirm">
                <span class="confirm-label">Delete {{ selectedCount() }} permanently?</span>
                <button class="toolbar-btn confirm-yes" (click)="confirmBulkDelete()" [disabled]="isBulkProcessing()">
                    @if (isBulkProcessing()) {
                    <i class="bi bi-arrow-repeat spin"></i>
                    } @else {
                    Yes
                    }
                </button>
                <button class="toolbar-btn confirm-no" (click)="cancelBulkDelete()"
                    [disabled]="isBulkProcessing()">No</button>
            </div>
            } @else {
            <button class="toolbar-btn restore-action" (click)="bulkRestore()"
                [disabled]="selectedCount() === 0 || isBulkProcessing()">
                @if (isBulkProcessing()) {
                <i class="bi bi-arrow-repeat spin"></i>
                } @else {
                <i class="bi bi-arrow-counterclockwise"></i>
                }
                <span class="btn-label">Restore</span>
            </button>
            <button class="toolbar-btn delete-action" (click)="requestBulkDelete()" [disabled]="selectedCount() === 0">
                <i class="bi bi-trash"></i>
                <span class="btn-label">Delete</span>
            </button>
            }
        </div>
    </div>
    }

    @if (isLoading()) {
    <div class="loading-state">
        <i class="bi bi-arrow-repeat spin"></i>
        <span>Loading...</span>
    </div>
    } @else if (!hasAnyTrashed()) {
    <div class="empty-state">
        <i class="bi bi-trash3"></i>
        <p>Your trash is empty.</p>
    </div>
    } @else {

    <!-- Workspaces section -->
    @if (trashedWorkspaces().length > 0) {
    <div class="trash-section">
        <div class="section-label">Workspaces</div>
        <div class="workspace-list">
            @for (ws of trashedWorkspaces(); track ws.id) {
            <div class="workspace-card" [class.processing]="processingId() === ws.id"
                [class.selected]="isSelected('ws:' + ws.id)" [class.in-select-mode]="selectionMode()"
                (click)="selectionMode() ? toggleSelect('ws:' + ws.id) : null">

                <!-- Selection checkbox (square) -->
                @if (selectionMode()) {
                <div class="card-checkbox" (click)="$event.stopPropagation(); toggleSelect('ws:' + ws.id)">
                    <i class="bi" [class.bi-check-square-fill]="isSelected('ws:' + ws.id)"
                        [class.bi-square]="!isSelected('ws:' + ws.id)"></i>
                </div>
                }

                <div class="card-info">
                    <div class="icon-wrapper">
                        <i class="bi" [class.bi-person-workspace]="ws.role === 'personal'"
                            [class.bi-people]="ws.role === 'team'">
                        </i>
                    </div>
                    <div class="details">
                        <h3>{{ ws.name }}</h3>
                        <span class="role-badge" [class.team]="ws.role === 'team'">
                            {{ ws.role | titlecase }}
                        </span>
                    </div>
                </div>

                @if (!selectionMode()) {
                <div class="card-status">
                    <div class="status-badge trashed">
                        <i class="bi bi-clock-history"></i>
                        <span>{{ getDaysLeft(ws.trashedAt) }}</span>
                    </div>
                    <span class="time-info">Trashed {{ ws.trashedAt | timeAgo }}</span>

                    <div class="card-actions">
                        @if (confirmingDeleteId() === ws.id) {
                        <div class="confirm-actions">
                            <span class="confirm-text">Delete permanently?</span>
                            <div class="btn-group">
                                <button class="confirm-yes" (click)="confirmDelete(ws.id)"
                                    [disabled]="processingId() === ws.id">
                                    @if (processingId() === ws.id) {
                                    <i class="bi bi-arrow-repeat spin"></i>
                                    } @else {
                                    Yes
                                    }
                                </button>
                                <button class="confirm-no" (click)="cancelDelete()"
                                    [disabled]="processingId() === ws.id">No</button>
                            </div>
                        </div>
                        } @else {
                        <button class="action-btn restore-btn" [disabled]="processingId() === ws.id"
                            (click)="restoreWorkspace(ws.id)" aria-label="Restore" title="Restore">
                            @if (processingId() === ws.id) {
                            <i class="bi bi-arrow-repeat spin"></i>
                            } @else {
                            <i class="bi bi-arrow-counterclockwise"></i>
                            }
                        </button>
                        <button class="action-btn delete-btn" [disabled]="processingId() === ws.id"
                            (click)="requestPermanentDelete(ws.id)" aria-label="Delete permanently"
                            title="Delete permanently">
                            <i class="bi bi-trash"></i>
                        </button>
                        }
                    </div>
                </div>
                }
            </div>
            }
        </div>
    </div>
    }

    <!-- Spaces section -->
    @if (trashedSpaces().length > 0) {
    <div class="trash-section">
        <div class="section-label">Spaces</div>
        <div class="workspace-list">
            @for (space of trashedSpaces(); track space.id) {
            <div class="workspace-card space-card" [class.processing]="processingId() === space.id"
                [class.selected]="isSelected('sp:' + space.id)" [class.in-select-mode]="selectionMode()"
                (click)="selectionMode() ? toggleSelect('sp:' + space.id) : null">

                <!-- Selection checkbox -->
                @if (selectionMode()) {
                <div class="card-checkbox" (click)="$event.stopPropagation(); toggleSelect('sp:' + space.id)">
                    <i class="bi" [class.bi-check-square-fill]="isSelected('sp:' + space.id)"
                        [class.bi-square]="!isSelected('sp:' + space.id)"></i>
                </div>
                }

                <div class="card-info">
                    <div class="icon-wrapper space-icon">
                        <i class="bi bi-folder"></i>
                    </div>
                    <div class="details">
                        <h3>{{ space.name }}</h3>
                        <span class="role-badge space-badge">Space</span>
                    </div>
                </div>

                @if (!selectionMode()) {
                <div class="card-status">
                    <div class="status-badge trashed">
                        <i class="bi bi-clock-history"></i>
                        <span>{{ getDaysLeft(space.trashedAt) }}</span>
                    </div>
                    <span class="time-info">Trashed {{ space.trashedAt | timeAgo }}</span>

                    <div class="card-actions">
                        @if (confirmingDeleteSpaceId() === space.id) {
                        <div class="confirm-actions">
                            <span class="confirm-text">Delete permanently?</span>
                            <div class="btn-group">
                                <button class="confirm-yes" (click)="confirmDeleteSpace(space.id)"
                                    [disabled]="processingId() === space.id">
                                    @if (processingId() === space.id) {
                                    <i class="bi bi-arrow-repeat spin"></i>
                                    } @else {
                                    Yes
                                    }
                                </button>
                                <button class="confirm-no" (click)="cancelDeleteSpace()"
                                    [disabled]="processingId() === space.id">No</button>
                            </div>
                        </div>
                        } @else {
                        <button class="action-btn restore-btn" [disabled]="processingId() === space.id"
                            (click)="restoreSpace(space.id)" aria-label="Restore" title="Restore">
                            @if (processingId() === space.id) {
                            <i class="bi bi-arrow-repeat spin"></i>
                            } @else {
                            <i class="bi bi-arrow-counterclockwise"></i>
                            }
                        </button>
                        <button class="action-btn delete-btn" [disabled]="processingId() === space.id"
                            (click)="requestDeleteSpace(space.id)" aria-label="Delete permanently"
                            title="Delete permanently">
                            <i class="bi bi-trash"></i>
                        </button>
                        }
                    </div>
                </div>
                }
            </div>
            }
        </div>
    </div>
    }

    }
</div>
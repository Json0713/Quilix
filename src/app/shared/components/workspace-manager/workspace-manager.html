<div class="manager-container">
    <div class="manager-header">
        <div class="header-text">
            <h2>My Workspaces</h2>
            <p>Manage your workspaces and their associated local files.</p>
        </div>

        @if (!isLoading() && workspaces().length > 0) {
        <button class="select-toggle-btn" (click)="toggleSelectionMode()" [class.active]="selectionMode()">
            @if (selectionMode()) {
            <i class="bi bi-x-lg"></i>
            <span>Cancel</span>
            } @else {
            <i class="bi bi-check2-square"></i>
            <span>Select</span>
            }
        </button>
        }
    </div>

    <!-- Re-auth banner (permission lost after reload on mobile) -->
    @if (needsReauth() && isFileSystemMode()) {
    <div class="reauth-banner">
        <div class="reauth-info">
            <i class="bi bi-shield-lock"></i>
            <div class="reauth-text">
                <strong>Storage access expired</strong>
                <span>Reconnect to check folder status and manage local files.</span>
            </div>
        </div>
        <button class="reauth-btn" (click)="reconnectStorage()" [disabled]="isReauthing()">
            @if (isReauthing()) {
            <i class="bi bi-arrow-repeat spin"></i>
            <span>Connecting...</span>
            } @else {
            <i class="bi bi-plug"></i>
            <span>Reconnect Storage</span>
            }
        </button>
    </div>
    }

    <!-- Selection toolbar -->
    @if (selectionMode()) {
    <div class="selection-toolbar">
        <div class="toolbar-left">
            <button class="toolbar-btn checkbox-btn" (click)="toggleSelectAll()" [class.checked]="isAllSelected()">
                <i class="bi" [class.bi-check-square-fill]="isAllSelected()" [class.bi-square]="!isAllSelected()"></i>
            </button>
            <span class="selection-count">
                {{ selectedCount() }} selected
            </span>
        </div>

        <div class="toolbar-actions">
            @if (confirmingBulkTrash()) {
            <div class="bulk-confirm">
                <span class="confirm-label">Trash {{ selectedCount() }} workspace{{ selectedCount() > 1 ? 's' : ''
                    }}?</span>
                <button class="toolbar-btn confirm-yes" (click)="confirmBulkTrash()" [disabled]="isBulkProcessing()">
                    @if (isBulkProcessing()) {
                    <i class="bi bi-arrow-repeat spin"></i>
                    } @else {
                    Yes
                    }
                </button>
                <button class="toolbar-btn confirm-no" (click)="cancelBulkTrash()"
                    [disabled]="isBulkProcessing()">No</button>
            </div>
            } @else {
            @if (isFileSystemMode() && hasSelectedMissing()) {
            <button class="toolbar-btn restore-action" (click)="bulkRestoreFolders()" [disabled]="isBulkProcessing()">
                @if (isBulkProcessing()) {
                <i class="bi bi-arrow-repeat spin"></i>
                } @else {
                <i class="bi bi-arrow-counterclockwise"></i>
                }
                <span class="btn-label">Restore Folders</span>
            </button>
            }
            <button class="toolbar-btn trash-action" (click)="requestBulkTrash()" [disabled]="selectedCount() === 0">
                <i class="bi bi-trash3"></i>
                <span class="btn-label">Trash</span>
            </button>
            }
        </div>
    </div>
    }

    @if (isLoading()) {
    <div class="loading-state">
        <i class="bi bi-arrow-repeat spin"></i>
        <span>Loading workspaces...</span>
    </div>
    } @else if (workspaces().length === 0) {
    <div class="empty-state">
        <i class="bi bi-folder-x"></i>
        <p>No workspaces found.</p>
    </div>
    } @else {
    <div class="workspace-list">
        @for (ws of workspaces(); track ws.id) {
        <div class="workspace-card" [class.missing]="ws.isMissingOnDisk" [class.selected]="isSelected(ws.id)"
            [class.in-select-mode]="selectionMode()" [class.expanded]="expandedWorkspaceId() === ws.id"
            (click)="selectionMode() ? toggleSelect(ws.id) : null">

            <!-- Selection checkbox (square) -->
            @if (selectionMode()) {
            <div class="card-checkbox" (click)="$event.stopPropagation(); toggleSelect(ws.id)">
                <i class="bi" [class.bi-check-square-fill]="isSelected(ws.id)"
                    [class.bi-square]="!isSelected(ws.id)"></i>
            </div>
            }

            <div class="card-info">
                <div class="icon-wrapper">
                    <i class="bi" [class.bi-person-workspace]="ws.role === 'personal'"
                        [class.bi-people]="ws.role === 'team'">
                    </i>
                </div>
                <div class="details">
                    <h3>{{ ws.name }}</h3>
                    <span class="role-badge" [class.team]="ws.role === 'team'">
                        {{ ws.role | titlecase }}
                    </span>
                </div>
            </div>

            @if (!selectionMode()) {
            <div class="card-status">
                @if (isFileSystemMode()) {
                @if (ws.isMissingOnDisk) {
                <div class="status-badge error">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>Folder Missing</span>
                </div>
                <button class="btn btn-primary restore-btn" [disabled]="ws.isRestoring || ws.isTrashing"
                    (click)="restoreWorkspace(ws)">
                    @if (ws.isRestoring) {
                    <i class="bi bi-arrow-repeat spin"></i> Restoring...
                    } @else {
                    <i class="bi bi-arrow-counterclockwise"></i> Restore
                    }
                </button>
                } @else {
                <div class="status-badge success">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Folder Synced</span>
                </div>
                }
                } @else {
                <div class="status-badge info">
                    <i class="bi bi-database"></i>
                    <span>IndexedDB</span>
                </div>
                }

                <div class="card-actions">
                    @if (confirmingTrashId() === ws.id) {
                    <div class="confirm-actions">
                        <span class="confirm-text">Trash it?</span>
                        <div class="btn-group">
                            <button class="confirm-yes" (click)="confirmTrash(ws)" [disabled]="ws.isTrashing">
                                @if (ws.isTrashing) {
                                <i class="bi bi-arrow-repeat spin"></i>
                                } @else {
                                Yes
                                }
                            </button>
                            <button class="confirm-no" (click)="cancelTrash()" [disabled]="ws.isTrashing">No</button>
                        </div>
                    </div>
                    } @else {
                    <!-- Expand/collapse toggle -->
                    @if (isFileSystemMode() && !ws.isMissingOnDisk) {
                    <button class="action-btn expand-btn" (click)="toggleExpand(ws)"
                        [class.active]="expandedWorkspaceId() === ws.id" aria-label="View spaces" title="View spaces">
                        <i class="bi" [class.bi-chevron-down]="expandedWorkspaceId() === ws.id"
                            [class.bi-chevron-right]="expandedWorkspaceId() !== ws.id"></i>
                    </button>
                    }
                    <button class="action-btn trash-btn" [disabled]="ws.isTrashing" (click)="requestTrash(ws)"
                        aria-label="Move to trash" title="Move to trash">
                        @if (ws.isTrashing) {
                        <i class="bi bi-arrow-repeat spin"></i>
                        } @else {
                        <i class="bi bi-trash3"></i>
                        }
                    </button>
                    }
                </div>
            </div>
            }

            <!-- Expanded space list -->
            @if (expandedWorkspaceId() === ws.id && !selectionMode()) {
            <div class="space-panel">
                @if (isLoadingSpaces()) {
                <div class="space-loading">
                    <i class="bi bi-arrow-repeat spin"></i>
                    <span>Loading spaces...</span>
                </div>
                } @else if (getSpaces(ws.id).length === 0) {
                <div class="space-empty">
                    <span>No spaces in this workspace</span>
                </div>
                } @else {
                @if (hasMissingSpaces(ws.id)) {
                <div class="space-panel-toolbar">
                    <span class="missing-count">
                        {{ getSpaces(ws.id).length }} space{{ getSpaces(ws.id).length > 1 ? 's' : '' }}
                    </span>
                    <button class="restore-all-btn" (click)="restoreAllSpaces(ws)">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        Restore All
                    </button>
                </div>
                }
                <div class="space-list">
                    @for (space of getSpaces(ws.id); track space.id) {
                    <div class="space-row" [class.missing]="space.isMissingOnDisk">
                        <div class="space-info">
                            <i class="bi bi-folder2"></i>
                            <span class="space-name">{{ space.name }}</span>
                        </div>
                        <div class="space-status">
                            @if (space.isMissingOnDisk) {
                            <span class="status-badge error">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                Missing
                            </span>
                            <button class="space-restore-btn" [disabled]="space.isRestoring"
                                (click)="restoreSpace(ws, space)">
                                @if (space.isRestoring) {
                                <i class="bi bi-arrow-repeat spin"></i>
                                } @else {
                                <i class="bi bi-arrow-counterclockwise"></i>
                                Restore
                                }
                            </button>
                            } @else {
                            <span class="status-badge success">
                                <i class="bi bi-check-circle-fill"></i>
                                Synced
                            </span>
                            }
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
        }
    </div>
    }
</div>